<template>
    <div class="login-title">
        <img class="icon" src="@/assets/image/logo.png" alt="logo" />
        <h2 class="title">Racio管理员登录</h2>
    </div>
    <el-form ref="ruleFormRef" :model="ruleForm" :rules="rules">
        <el-form-item label="" prop="username">
            <el-input v-model="ruleForm.username" placeholder="请输入用户名" auto-complete="on" style="position: relative"
                @keyup.enter="submitForm(ruleFormRef)">
                <template #prefix>
                    <el-icon class="el-input__icon">
                        <UserFilled />
                    </el-icon>
                </template>
            </el-input>
        </el-form-item>

        <el-form-item label="" prop="password">
            <el-input v-model="ruleForm.password" placeholder="请输入密码" auto-complete="on" :type="passwordType"
                @keyup.enter="submitForm(ruleFormRef)">
                <template #prefix>
                    <el-icon class="el-input__icon">
                        <GoodsFilled />
                    </el-icon>
                </template>
                <template #suffix>
                    <div class="show-pwd" @click="showPwd">
                        <svg-icon :icon-class="passwordType === 'password' ? 'eye' : 'eye-open'" />
                    </div>
                </template>
            </el-input>
        </el-form-item>

        <el-form-item style="width: 100%">
            <el-button :loading="loading" class="login-btn btn btn-primary" type="primary"
                @click="submitForm(ruleFormRef)">登录</el-button>
        </el-form-item>
    </el-form>
</template>
<script lang="ts" setup>
import { ref, reactive } from "vue"
import type { FormInstance } from "element-plus"
import { ElNotification, roleTypes } from "element-plus"
import { useRouter } from "vue-router"
import { useUserStore } from "@/store/modules/user"
import { getTimeStateStr } from "@/utils/index"
import { login } from "@/api/api"

const router = useRouter()
const UserStore = useUserStore()
const ruleFormRef = ref<FormInstance>()
const passwordType = ref("password")
const loading = ref(false)

const rules = reactive({
    password: [{ required: true, message: "请输入用户名", trigger: "blur" }],
    username: [{ required: true, message: "请输入密码", trigger: "blur" }],
})

// 表单数据
const ruleForm = reactive({
    username: "",
    password: "",
})

// 显示密码图标
const showPwd = () => {
    passwordType.value = passwordType.value === "password" ? "" : "password"
}

const submitForm = (formEl: FormInstance | undefined) => {
    if (!formEl) return
    formEl.validate(async valid => {
        if (valid) {
            loading.value = true
            // 登录

            login(ruleForm)
                .then(res => {
                    let { data, code, msg } = res.data


                    if (code == 0) {
                        let userInfo = {
                            token: data,
                            roles: ["superAdmin"],
                            username: "Racio"
                        }
                        UserStore.login(userInfo)

                        ElNotification({
                            title: getTimeStateStr(),
                            message: "欢迎登录 Racio",
                            type: "success",
                            duration: 3000,
                        })
                        router.replace("/admin")
                    } else {
                        ElNotification({
                            message: msg,
                            type: "error",
                            duration: 2000,
                        })
                    }
                })
                .catch(error => {
                    ElNotification({
                        message: error.response.data.msg,
                        type: "error",
                        duration: 3000,
                    })
                })



            loading.value = false

        } else {
            console.log("error submit!")
            return false
        }
    })
}
</script>

<style lang="scss" scoped>
@import "../index.scss";
</style>
